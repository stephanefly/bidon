{% extends 'trunks/main/base.html' %}
{% block content %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'lst_projets' %}">Liste des Projets</a></li>
            <li class="breadcrumb-item"><a>{{ projet.name }}</a></li>
        </ol>
    </nav>
    <h2 style="text-align: center;">Liste des Etats du Projet - {{ projet.name }}</h2>
    <br>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createEtatModal">
        Nouvel état
    </button>
        <br>    <br>
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-warning">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
    <hr>
    <table id="tableetat" class="table table-bordered table-striped">
        <thead>
        <th>Nom</th>
        <th>Created by</th>
        <th>Modify by</th>
        <th>Created At</th>
        <th>Updated At</th>
        <th>Gelé</th>
        <th>Actions</th>
        </thead>
        <tbody>
        {% for etat in lst_etat %}
            <tr>
                <td><a href="{% url 'info_etat' etat.id %}">{{ etat.name }}</a></td>
                <td>{{ etat.created_by }}</td>
                <td>{{ etat.modify_by }}</td>
                <td>{{ etat.created_at }}</td>
                <td>{{ etat.updated_at }}</td>
                <td>{{ etat.freeze }}</td>
                <td>
                    {% if not etat.freeze %}


                        <a data-bs-toggle="modal" data-bs-target="#renameEtatModal-{{ etat.id }}">
                                                <button type="button" class="btn btn-primary btn-sm"><i class="bi bi-pencil-fill" title="Renommer"></i>
              </button>
                    </a>
                                                <a href="{% url 'freeze_etat' etat.id %}"
                           onclick="return confirm('Êtes-vous sûr de geler cet etat ?');">
                            <button type="button" class="btn btn-info btn-sm"><i class="bi bi-snow2" style="color:#ffffff" title="Geler"></i></button>
                        </a>
                                                <a href="{% url 'delete_etat' etat.id %}" class="btn btn-danger btn-sm"
                           onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet état  ?');">
                            <i class="bi bi-trash-fill" title="Supprimer"></i>
                        </a>
                    {% else %}
                        <a href="{% url 'defreeze_etat' etat.id %}"
                           onclick="return confirm('Êtes-vous sûr de vouloir dégeler cet état  ?');">
                            <button type="button" class="btn btn-warning btn-sm"><i class="bi bi-fire" style="color:#ff0000;" title="Dégeler"></i></button>
                        </a>
                    {% endif %}
                                    <button onclick="copyToClipboard('{{ etat.work_directory|escapejs }}')" 
                            class="btn btn-primary btn-sm">
                        
                        <i class="bi bi-folder" title="Ouvrir le dossier de travail" ></i>
                    
                    </button>
                    <a data-bs-toggle="modal" data-bs-target="#duplicateEtatModal-{{ etat.id }}">
                        <button type="button" class="btn btn-primary btn-sm"><i class="bi bi-files icon-action" title="Dupliquer"></i></button>
                    </a>


                </td>
            </tr>
            <!-- Modal pour chaque état -->
            <div class="modal fade" id="duplicateEtatModal-{{ etat.id }}" tabindex="-1"
                 aria-labelledby="duplicateEtatModalLabel-{{ etat.id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="post" action="{% url 'duplicate_etat' etat.id %}">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title" id="dupplicateEtatModalLabel-{{ etat.id }}">Dupliquer l'état
                                    : {{ etat.name }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="form-floating">
                                    <input type="text" name="new_name" class="form-control"
                                           id="floatingNewName-{{ etat.id }}"
                                           placeholder="Nom du nouvel état" required>
                                    <label for="floatingNewName-{{ etat.id }}">Nom du nouvel état</label>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                <button type="submit" class="btn btn-primary">Dupliquer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Rename Modal pour chaque état -->
            <div class="modal fade" id="renameEtatModal-{{ etat.id }}" tabindex="-1"
                 aria-labelledby="renameEtatModalLabel-{{ etat.id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="post" action="{% url 'rename_etat' etat.id %}">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title" id="renameEtatModalLabel-{{ etat.id }}">Renommer l'état
                                    : {{ etat.name }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="form-floating">
                                    <input type="text" name="new_name" class="form-control"
                                           id="floatingNewName-{{ etat.id }}"
                                           placeholder="Nouveau nom de l'état" value="{{ etat.name }}" required>
                                    <label for="floatingNewName-{{ etat.id }}">Nouveau nom de l'état</label>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler
                                </button>
                                <button type="submit" class="btn btn-primary">Renommer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}
        </tbody>
    </table>
    <!-- Modal Nouvel-->
    <div class="modal fade" id="createEtatModal" tabindex="-1" aria-labelledby="createEtatModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'info_projet' projet.id %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="createEtatModalLabel">Créer un nouvel Etat</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                    </div>
                    <div class="modal-body">
                        {{ form.as_p }}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Créer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script type="text/javascript">
        $(document).ready(function () {
            $('#tableetat').DataTable({
                order: [[0, 'asc']],
                info: false,         // Cache le nombre d'entrées
                paging: false,       // Désactive la pagination
                searching: false,    // Désactive la barre de recherche
                lengthChange: false  // Désactive le choix du nombre de lignes par page
            });
        });

    </script>
    <script>
   function copyToClipboard(text) {
       // Copie dans le presse-papier
       navigator.clipboard.writeText(text).then(function() {
           afficherNotif2("Copié dans le presse-papier : " + text);
       }, function() {
           afficherNotif2("Erreur lors de la copie !");
       });
   }

   function afficherNotif2(message) {
       let notif = document.getElementById('custom-notif');
       if (!notif) {
           notif = document.createElement('div');
           notif.id = 'custom-notif';
           notif.style.position = 'fixed';
           notif.style.top = '20px';
           notif.style.right = '20px';
           notif.style.minWidth = '250px';
           notif.style.zIndex = 99999;
           notif.style.padding = '16px 18px';
           notif.style.borderRadius = '12px';
           notif.style.fontSize = '1rem';
           notif.style.color = '#fff';
           notif.style.fontWeight = "bold";
           notif.style.background = "#471448";
           notif.style.boxShadow = '0 2px 10px rgba(0,0,0,0.11)';
           document.body.appendChild(notif);
       }
       notif.innerHTML = message;
       notif.style.display = 'block';

       // Disparition auto après 2,5 secondes
       setTimeout(function() {
           notif.style.display = "none";
       }, 2500);
   }
</script>
{% endblock %}